<!doctype html>
<html>
  <head>
    <title>ClueLess</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="node_modules/custombox/src/css/custombox.css">
    <script src="//cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="/node_modules/custombox/src/js/custombox.js"></script>
  </head>
  <body>
    <div id="loginModal" class="flex-container">
    <form id="loginForm" action="">
      <input id="nameInput" required/><br>
      <select id="characterSelect" name="character">
        <option value="MissScarlet">Miss Scarlet</option>
        <option value="ColonelMustard">Colonel Mustard</option>
        <option value="MrsWhite">Mrs. White</option>
        <option value="MrGreen">Mr. Green</option>
        <option value="MrsPeacock">Mrs. Peacock</option>
        <option value="ProfessorPlum">Professor Plum</option>
      </select><br>
      <input type="submit" value="Login">
    </form>
    </div>

    <div id="mainContainer">
      <div id="gameBoardContainer" class="flex-container">
        <div id="gameColumn1" class="gameBoardColumn">
          <canvas id="Study" class="room"></canvas>
          <canvas id="Study_Library" class="hallway vertical"></canvas>
          <canvas id="Library" class="room"></canvas>
          <canvas id="Library_Conservatory" class="hallway vertical"></canvas>
          <canvas id="Conservatory" class="room"></canvas>
        </div>
        <div id="gameColumn2" class="gameBoardColumn">
          <canvas id="Study_Hall" class="hallway horizontal"></canvas>
          <canvas></canvas>
          <canvas id="Library_BilliardRoom" class="hallway horizontal"></canvas>
          <canvas></canvas>
          <canvas id="Conservatory_Ballroom" class="hallway horizontal"></canvas>
        </div>
        <div id="gameColumn3" class="gameBoardColumn">
          <canvas id="Hall" class="room"></canvas>
          <canvas id="Hall_BilliardRoom" class="hallway vertical"></canvas>
          <canvas id="BilliardRoom" class="room"></canvas>
          <canvas id="BilliardRoom_Ballroom" class="hallway vertical"></canvas>
          <canvas id="Ballroom" class="room"></canvas>
        </div>
        <div id="gameColumn4" class="gameBoardColumn">
          <canvas id="Hall_Lounge" class="hallway horizontal"></canvas>
          <canvas></canvas>
          <canvas id="BilliardRoom_DiningRoom" class="hallway horizontal"></canvas>
          <canvas></canvas>
          <canvas id="Ballroom_Kitchen" class="hallway horizontal"></canvas>
        </div>
        <div id="gameColumn5" class="gameBoardColumn">
          <canvas id="Lounge" class="room"></canvas>
          <canvas id="Lounge_DiningRoom" class="hallway vertical"></canvas>
          <canvas id="DiningRoom" class="room"></canvas>
          <canvas id="DiningRoom_Kitchen" class="hallway vertical"></canvas>
          <canvas id="Kitchen" class="room"></canvas>
        </div>
      </div>
      <div id="chatContainer"  class="flex-container">
      <ul id="messages"></ul>
      <form id="chatForm" action="">
        <input id="messageInput" autocomplete="off" required/>
        <button class="submitMessage">Send</button>
      </form>
      </div>
      <br syle="lineBreak"/>
    </div>
    <script>
    //Global playerData object;
    var playerData;

    //Execute when the document and jQuery are ready
    $(function(){
      //Instantiate the socket object
      var socket = io();
    
      /**
      *Handles submit of the chat form
      **/
      $('form#chatForm').submit(function(){
        socket.emit('message', $('#messageInput').val());
        $('#messageInput').val('');
        return false;
      });

      /**
      *Handles submit of login form
      **/
      $('form#loginForm').submit(function(){
        socket.emit('login', $('input#nameInput').val(), $('select#characterSelect option:selected').val());
        Custombox.close();
        return false;
      });

      /**
      *Socket listener for server-sent event chatMessage
      **/
      socket.on('playerConnection', function(data){
        playerData = data;
        initiateLogin();
      });

      /**
      *Socket listener for server-sent event playerLogin
      **/
      socket.on('playerLogin', function(player){
        $('#loginModal').addClass('noDisplay');
        createCharacterNode(player.character);
        socket.emit('triggerUpdate');    

        //Allows player to drag character
        $('character#' + player.character).addClass('draggable');
        $('character#' + player.character).draggable({
          containment: "#gameBoardContainer",
          snap: "canvas",
          snapMode: "inner",
          stop: function (event, ui) {
            var possibleTargets = $('canvas').filter(function(index) {
                return ($(this).offset().left <= ui.offset.left && $(this).offset().top <= ui.offset.top);
            });


            var currentPlayerData = playerData.filter(function (data){
              return data.id == player.id;
            })[0];

            var target = possibleTargets[possibleTargets.length-1];

            if(validMove(currentPlayerData.location, target)){
              if(possibleTargets.length > 0 && target.id){
                //if the target is a hallway then check to make sure it isn't occupied
                if(target.id.indexOf('_') != -1){
                  var occupiedLocation = playerData.filter(function (data){
                    return data.location == target.id;
                  });
                  if(occupiedLocation.length == 0){
                    socket.emit('moveTo', player.character, target.id);
                  }
                }
                else{
                  socket.emit('moveTo', player.character, target.id);
                }
              }
            }
            else{
              alert('Please make a valid move');
            }
            socket.emit('triggerUpdate');
          }
        });
      });

      /**
      *Socket listener for server-sent event updateBoard
      **/
      socket.on('updateBoard', function(data){
        console.log('updating the game board');
        updateGameBoard(data);
      });

      /**
      *Socket listener for server-sent event removePlayer
      **/
      socket.on('removePlayer', function(player){
        console.log('removing ' + player.character + ' from the game board');
        removePlayer(player);
      });

      /**
      *Socket listener for server-sent event chatMessage
      **/
      socket.on('chatMessage', function(player, msg){
        displayChatMessage(player.name + ' : ' + msg);
      });
    });

    /**
    *Creates the input character node and adds it to the board
    **/
    function createCharacterNode(character) { 
      displayChatMessage(character + ' has been added to the board');
      $('div#gameBoardContainer').prepend($('<character id="' + character +'"">'));
    }

    /**
    *Creates the login screen and displays it to the user upon startup
    **/
    function initiateLogin() {
      if(playerData && playerData.length == 6){
        $('#loginModal').addClass('noDisplay');
        alert('The game room is currently full');
      }

      else {
        if(playerData){
          //removes unavailable characters from dropdown nmenu
          for(var i=0; i < playerData.length; i++){
            $('select#characterSelect option[value="' + playerData[i].character + '"]').remove();
          }
        }
        Custombox.open({
          target: '#loginModal',
          effect: 'fadein',
          escKey: false,
          overlayClose: false,
        });
      }
    }

    /**
    *Update the location of the characters on the game board
    */
    function updateGameBoard (data) {
      playerData = data;
      $.each(playerData, function(i, player){
          if($('character[id="' + player.character+'"]').length == 0){
            createCharacterNode(player.character);
          }
          var position = $('#' + player.location).position();        
          $('character[id="' + player.character +'"]').css({'top': position.top, 'left':position.left});
        });
    }

    /**
    *Removes the player from the game board
    */
    function removePlayer (player) {
        if($('character#' + player.character).length > 0){
          $('character#' + player.character).remove();
        }
    }
    function validMove(currentLocation, targetLocation){
      var validMoves = {
        Study : ['Study_Hall', 'Study_Library', 'Kitchen'],
        Hall : ['Study_Hall', 'Hall_Lounge', 'Hall_BilliardRoom'],
        Lounge : ['Hall_Lounge', 'Lounge_DiningRoom', 'Conservatory'],
        Library : ['Study_Library', 'Library_BilliardRoom', 'Library_Conservatory'],
        BilliardRoom : ['Library_BilliardRoom', 'Hall_BilliardRoom', 'BilliardRoom_DiningRoom', 'BilliardRoom_Ballroom'],
        DiningRoom : ['Lounge_DiningRoom', 'BilliardRoom_Dining', 'DiningRoom_Kitchen'],
        Conservatory : ['Library_Conservatory', 'Conservatory_Ballroom', 'Lounge'],
        Ballroom : ['Conservatory_Ballroom', 'BilliardRoom_Ballroom', 'Ballroom_Kitchen'],
        Kitchen : ['Ballroom_Kitchen', 'DiningRoom_Kitchen', 'Study'],
        Study_Hall : ['Study', 'Hall'],
        Hall_Lounge : ['Hall', 'Lounge'],
        Study_Library : ['Study', 'Library'],
        Hall_BilliardRoom : ['Hall', 'BilliardRoom'],
        Lounge_DiningRoom : ['Lounge', 'DiningRoom'],
        Library_BilliardRoom : ['Library', 'BilliardRoom'],
        BilliardRoom_DiningRoom : ['BilliardRoom', 'DiningRoom'],
        Library_Conservatory : ['Library', 'Conservatory'],
        BilliardRoom_Ballroom : ['BilliardRoom', 'Ballroom'] ,
        DiningRoom_Kitchen :  ['DiningRoom', 'Kitchen'],
        Conservatory_Ballroom : ['Conservatory', 'Ballroom'],
        Ballroom_Kitchen : ['Ballroom', 'Kitchen'] 
    }

    return validMoves[currentLocation].indexOf(targetLocation.id) != -1;
  }

    /**
    *Display the input message in the chat window
    */
    function displayChatMessage (msg) {
      $('#messages').append($('<li>').text(msg));
      window.scrollTo(0, document.body.scrollHeight);
    }
    </script>
  </body>
</html>