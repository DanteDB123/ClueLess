<!doctype html>
<html>
  <head>
    <title>ClueLess</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="node_modules/custombox/src/css/custombox.css">
    <script src="//cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="/node_modules/custombox/src/js/custombox.js"></script>
  </head>
  <body>
    <div id="loginModal" class="flex-container">
    <form id="loginForm" action="">
      <input id="nameInput" required/><br>
      <select id="characterSelect" name="character">
        <option value="Miss Scarlet">Miss Scarlet</option>
        <option value="Colonel Mustard">Colonel Mustard</option>
        <option value="Mrs. White">Mrs. White</option>
        <option value="Mr. Green">Mr. Green</option>
        <option value="Mrs. Peacock">Mrs. Peacock</option>
        <option value="Professor Plum">Professor Plum</option>
      </select><br>
      <input type="submit" value="Login">
    </form>
    </div>

    <div id="mainContainer">
      <div id="gameBoardContainer" class="flex-container">
        <div id="gameColumn1" class="gameBoardColumn">
          <canvas id="Study" class="room"></canvas>
          <canvas id="Study_Library" class="hallway vertical"></canvas>
          <canvas id="Library" class="room"></canvas>
          <canvas id="Library_Conservatory" class="hallway vertical"></canvas>
          <canvas id="Conservatory" class="room"></canvas>
        </div>
        <div id="gameColumn2" class="gameBoardColumn">
          <canvas id="Study_Hall" class="hallway horizontal"></canvas>
          <canvas></canvas>
          <canvas id="Library_BilliardRoom" class="hallway horizontal"></canvas>
          <canvas></canvas>
          <canvas id="Conservatory_Ballroom" class="hallway horizontal"></canvas>
        </div>
        <div id="gameColumn3" class="gameBoardColumn">
          <canvas id="Hall" class="room"></canvas>
          <canvas id="Hall_BilliardRoom" class="hallway vertical"></canvas>
          <canvas id="BilliardRoom" class="room"></canvas>
          <canvas id="BilliardRoom_Ballroom" class="hallway vertical"></canvas>
          <canvas id="Ballroom" class="room"></canvas>
        </div>
        <div id="gameColumn4" class="gameBoardColumn">
          <canvas id="Hall_Lounge" class="hallway horizontal"></canvas>
          <canvas></canvas>
          <canvas id="BilliardRoom_DiningRoom" class="hallway horizontal"></canvas>
          <canvas></canvas>
          <canvas id="Ballroom_Kitchen" class="hallway horizontal"></canvas>
        </div>
        <div id="gameColumn5" class="gameBoardColumn">
          <canvas id="Lounge" class="room"></canvas>
          <canvas id="Lounge_DiningRoom" class="hallway vertical"></canvas>
          <canvas id="DiningRoom" class="room"></canvas>
          <canvas id="DiningRoom_Kitchen" class="hallway vertical"></canvas>
          <canvas id="Kitchen" class="room"></canvas>
        </div>
      </div>
      <div id="chatContainer"  class="flex-container">
      <ul id="messages"></ul>
      <form id="chatForm" action="">
        <input id="messageInput" autocomplete="off" required/>
        <button class="submitMessage">Send</button>
      </form>
      </div>
      <br syle="lineBreak"/>
    </div>
    <script>

    //Execute when the document and jQuery are ready
    $(function(){
      //Instantiate the socket object
      var socket = io();
    
      /**
      *Handles submit of the chat form
      **/
      $('form#chatForm').submit(function(){
        socket.emit('message', $('#messageInput').val());
        $('#messageInput').val('');
        return false;
      });

      /**
      *Handles submit of login form
      **/
      $('form#loginForm').submit(function(){
        socket.emit('login', $('input#nameInput').val(), $('select#characterSelect option:selected').val());
        Custombox.close();
        return false;
      });

      /**
      *Socket listener for server-sent event chatMessage
      **/
      socket.on('playerConnection', function(playerData){
        initiateLogin(playerData);
      });

      /**
      *Socket listener for server-sent event playerLogin
      **/
      socket.on('playerLogin', function(player){
        var validSnap = true;
        $('#loginModal').addClass('noDisplay');
        createCharacterNode(player.character);

        //Allows player to drag character
        $('character[id="' + player.character + '"]').addClass('draggable');
        $('character[id="' + player.character + '"]').draggable({
          containment: "#gameBoardContainer",
          snap: "canvas.room",
          stop: function (event, ui) {
            //debugger;
            var snapped = $(this).data('ui-draggable').snapElements;

            /* Pull out only the snap targets that are "snapping": */
            var snappedTo = $.map(snapped, function(element) {
                return element.snapping ? element.item : null;
            });

            var snappedObject = snappedTo[0];

            if(snappedObject){
              validSnap = true;
              socket.emit('moveTo', player.character, snappedObject.id);
            }
            else{
              validSnap = false;
            }  
          },
          revert: "invalid"
        });

          socket.emit('triggerUpdate');
        });

      /**
      *Socket listener for server-sent event updateBoard
      **/
      socket.on('updateBoard', function(playerData){
        console.log('updating the game board');
        updateGameBoard(playerData);
      });

      /**
      *Socket listener for server-sent event removePlayer
      **/
      socket.on('removePlayer', function(player){
        console.log('removing ' + player.character + ' from the game board');
        removePlayer(player);
      });

      /**
      *Socket listener for server-sent event chatMessage
      **/
      socket.on('chatMessage', function(player, msg){
        displayChatMessage(player.name + ' : ' + msg);
      });
    });

    /**
    *Creates the input character node and adds it to the board
    **/
    function createCharacterNode(character) { 
      displayChatMessage(character + ' has been added to the board');
      $('div#gameBoardContainer').prepend($('<character id="' + character +'"">').text(character));
    }

    /**
    *Creates the login screen and displays it to the user upon startup
    **/
    function initiateLogin(playerData) {
        if(playerData && playerData.length == 6){
          $('#loginModal').addClass('noDisplay');
          alert('The game room is currently full');
        }

        else {
          if(playerData){
            //removes unavailable characters from dropdown nmenu
            for(var i=0; i < playerData.length; i++){
              $('select#characterSelect option[value="' + playerData[i].character + '"]').remove();
            }
          }
          Custombox.open({
            target: '#loginModal',
            effect: 'fadein',
            escKey: false,
            overlayClose: false,
          });
        }
    }

    /**
    *Update the location of the characters on the game board
    */
    function updateGameBoard (playerData) {
      $.each(playerData, function(i, player){
          if($('character[id="' + player.character+'"]').length == 0){
            createCharacterNode(player.character);
          }
          var position = $('#' + player.location).position();        
          $('character[id="' + player.character +'"]').css({'top': position.top, 'left':position.left});
        });
    }

    /**
    *Removes the player from the game board
    */
    function removePlayer (player) {
        if($('character[id="' + player.character+'"]').length > 0){
          $('character[id="' + player.character+'"]').remove();
        }
    }

    /**
    *Display the input message in the chat window
    */
    function displayChatMessage (msg) {
      $('#messages').append($('<li>').text(msg));
      window.scrollTo(0, document.body.scrollHeight);
    }
    </script>
  </body>
</html>